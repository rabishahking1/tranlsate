<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karnali Language Translate</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js library for PDF processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Set the workerSrc for pdf.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        }
    </script>
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1f2937;
        }
        /* Tab styling */
        .tab {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        button:disabled {
            background-color: #9ca3af !important;
            cursor: not-allowed !important;
        }

        /* Document upload area styling */
        #doc-drop-area {
            border: 2px dashed #d1d5db;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        #doc-drop-area.dragover {
            border-color: #4f46e5;
            background-color: #f0f2f5;
        }
        #camera-view {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto bg-white/80 backdrop-blur-xl border border-gray-200 rounded-2xl shadow-2xl p-6 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Karnali Language Translate ðŸ˜Š</h1>
            <p class="text-gray-500 mt-2">Translate text, documents, and websites with AI.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6">
            <div class="flex border-b border-gray-200">
                <button data-tab="text" class="tab flex-1 md:flex-none md:px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 11-2 0V4H6v12a1 1 0 11-2 0V4zm4.5 5.5a.5.5 0 000 1h3a.5.5 0 000-1h-3zM9 12.5a.5.5 0 000 1h3a.5.5 0 000-1H9z" clip-rule="evenodd" /></svg>
                    Text
                </button>
                <button data-tab="document" class="tab flex-1 md:flex-none md:px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H9z" /><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm10 2a1 1 0 00-1-1H7a1 1 0 00-1 1v12a1 1 0 001 1h6a1 1 0 001-1V4z" clip-rule="evenodd" /></svg>
                    Document
                </button>
                <button data-tab="qa" class="tab flex-1 md:flex-none md:px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                    Q&A
                </button>
                <button data-tab="website" class="tab flex-1 md:flex-none md:px-6 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.72 7.97 5 10 5c2.03 0 3.488.72 4.756 1.321l.008.004a6.012 6.012 0 011.912 2.706C15.98 9.074 16 9.531 16 10c0 .469-.02 1.026-.544 2.073a6.012 6.012 0 01-1.912 2.706C12.512 15.28 11.03 16 10 16c-2.03 0-3.488-.72-4.756-1.321l-.008-.004a6.012 6.012 0 01-1.912-2.706C4.02 11.026 4 10.469 4 10c0-.469.02-.926.544-1.973z" clip-rule="evenodd" /></svg>
                    Website
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div id="tab-content">
            <!-- Text Translation UI -->
            <div id="text-tab-content" class="tab-pane active">
                <div class="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">âœ¨ AI Message Generator</label>
                    <div class="flex space-x-2">
                        <input type="text" id="ai-prompt" class="flex-grow p-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., write a thank you email for the gift">
                        <button id="generate-msg-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Generate</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
                    <select id="source-lang" class="w-full md:w-2/5 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                    <button id="swap-btn" class="p-2 rounded-full bg-gray-200 text-gray-600 hover:bg-indigo-600 hover:text-white transition-all duration-300 transform hover:rotate-180 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg></button>
                    <select id="target-lang" class="w-full md:w-2/5 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative"><textarea id="source-text" class="w-full h-64 p-4 bg-gray-50 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Enter text or use the AI generator..."></textarea><div class="absolute bottom-3 right-3 flex space-x-2"><button id="clear-btn" class="p-2 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition" title="Clear text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div>
                    <div class="relative"><textarea id="target-text" class="w-full h-64 p-4 bg-gray-50 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition" placeholder="Translation..." readonly></textarea><div class="absolute bottom-3 right-3 flex space-x-2"><button id="save-btn" class="p-2 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition" title="Save translation"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a3.5 3.5 0 01-3.5-3.5V6a2 2 0 012-2h10a2 2 0 012 2v6.5a3.5 3.5 0 01-3.5 3.5h-5zM5 6.5A1.5 1.5 0 006.5 5h7A1.5 1.5 0 0015 6.5v4.207a3.525 3.525 0 00-.012.28c-.289 1.63-.923 2.494-1.488 2.513H6.5A1.5 1.5 0 005 12.5V6.5z" /><path d="M10 11a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg></button><button id="copy-btn" class="p-2 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition" title="Copy translation"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div></div>
                </div>
                 <div class="mt-2 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <label for="tone-select" class="block text-sm font-medium text-gray-700 mb-1">âœ¨ Rewrite Tone</label>
                    <div class="flex space-x-2">
                        <select id="tone-select" class="flex-grow p-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Formal</option>
                            <option>Casual</option>
                            <option>Professional</option>
                            <option>Friendly</option>
                            <option>Poetic</option>
                        </select>
                        <button id="rewrite-tone-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Rewrite</button>
                    </div>
                </div>
            </div>

            <!-- Document Translation UI -->
            <div id="document-tab-content" class="tab-pane hidden">
                <div id="doc-drop-area" class="flex items-center justify-center w-full h-64 bg-gray-50/50 rounded-lg"><label for="doc-upload" class="flex flex-col items-center justify-center w-full h-full cursor-pointer"><div class="flex flex-col items-center justify-center pt-5 pb-6"><svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path></svg><p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p><p class="text-xs text-gray-400">PDF, PNG, or JPG</p></div><input id="doc-upload" type="file" class="hidden" accept="application/pdf, image/png, image/jpeg"/></label></div>
                <div class="flex space-x-2 mt-4">
                    <button id="scan-doc-btn" class="w-full flex items-center justify-center px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm2-2a1 1 0 00-1 1v8a1 1 0 001 1h12a1 1 0 001-1V6a1 1 0 00-1-1H4z" /><path d="M8 9a2 2 0 100-4 2 2 0 000 4z" /></svg>Scan with Camera</button>
                    <button id="summarize-doc-btn" class="w-full flex items-center justify-center px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition">âœ¨ Summarize</button>
                </div>
                <div id="doc-preview-container" class="hidden mt-4 text-center"><img id="image-preview" class="hidden max-w-full max-h-48 mx-auto rounded-lg shadow-md" /><div id="pdf-preview" class="hidden flex items-center justify-center p-4 bg-gray-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm5 2a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V5a1 1 0 00-1-1H9zM8 11a1 1 0 00-1 1v2a1 1 0 001 1h4a1 1 0 001-1v-2a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg><span id="pdf-name" class="text-sm font-medium"></span></div><button id="remove-doc-btn" class="mt-2 text-sm text-red-600 hover:text-red-500">Remove Document</button></div>
                 <p id="doc-status" class="text-center text-gray-500 mt-4"></p>
            </div>

            <!-- Q&A UI -->
            <div id="qa-tab-content" class="tab-pane hidden">
                <div class="space-y-4">
                    <div>
                        <label for="qa-question" class="block text-sm font-medium text-gray-700 mb-1">ðŸ¤” Ask the AI anything</label>
                        <textarea id="qa-question" rows="3" class="w-full p-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., What is the capital of Nepal?"></textarea>
                        <button id="get-answer-btn" class="mt-2 w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Get Answer</button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ðŸ¤– AI's Answer</label>
                        <div id="qa-answer" class="w-full h-64 p-4 bg-gray-50 border border-gray-300 rounded-lg overflow-y-auto">
                            <p class="text-gray-500">The answer will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Translation UI -->
            <div id="website-tab-content" class="tab-pane hidden">
                 <div class="text-center p-8 bg-gray-50/50 rounded-lg border border-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">Website Translate</h3>
                    <p class="mt-1 text-sm text-gray-500">Coming Soon...</p>
                </div>
            </div>
        </div>
        
        <!-- Translate Button -->
        <div class="mt-6 text-center">
            <button id="translate-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-all duration-300 transform hover:scale-105 shadow-lg">
                <span id="btn-text">Translate</span>
            </button>
        </div>

        <!-- Error/Toast -->
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><p id="error-text">Something went wrong.</p></div>
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">Text copied!</div>
        
        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
            <p>&copy; 2024 Karnali Language TranslateðŸ˜Š. Developed by <a href="http://shahrabi.com.np" target="_blank" class="text-indigo-500 hover:text-indigo-400">Rabi Shah</a>.</p>
            <div id="status-indicator" class="flex items-center">
                <div id="status-dot" class="h-3 w-3 rounded-full mr-2"></div>
                <span id="status-text"></span>
            </div>
        </footer>
    </div>
    
    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-lg">
        <p class="text-center font-semibold mb-2">Camera View</p>
        <video id="camera-view" autoplay playsinline class="bg-gray-200"></video>
        <canvas id="capture-canvas" class="hidden"></canvas>
        <div class="mt-4 flex justify-around space-x-4">
           <button id="capture-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition">Capture</button>
           <button id="cancel-scan-btn" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition">Cancel</button>
        </div>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const elements = {
                tabs: document.querySelectorAll('.tab'),
                tabPanes: {
                    text: document.getElementById('text-tab-content'),
                    document: document.getElementById('document-tab-content'),
                    qa: document.getElementById('qa-tab-content'),
                    website: document.getElementById('website-tab-content'),
                },
                aiPrompt: document.getElementById('ai-prompt'),
                generateMsgBtn: document.getElementById('generate-msg-btn'),
                sourceLang: document.getElementById('source-lang'),
                targetLang: document.getElementById('target-lang'),
                sourceText: document.getElementById('source-text'),
                targetText: document.getElementById('target-text'),
                translateBtn: document.getElementById('translate-btn'),
                btnText: document.getElementById('btn-text'),
                swapBtn: document.getElementById('swap-btn'),
                clearBtn: document.getElementById('clear-btn'),
                saveBtn: document.getElementById('save-btn'),
                copyBtn: document.getElementById('copy-btn'),
                error: { el: document.getElementById('error-message'), text: document.getElementById('error-text') },
                toast: document.getElementById('toast'),
                doc: {
                    dropArea: document.getElementById('doc-drop-area'),
                    uploadInput: document.getElementById('doc-upload'),
                    scanBtn: document.getElementById('scan-doc-btn'),
                    summarizeBtn: document.getElementById('summarize-doc-btn'),
                    previewContainer: document.getElementById('doc-preview-container'),
                    imagePreview: document.getElementById('image-preview'),
                    pdfPreview: document.getElementById('pdf-preview'),
                    pdfName: document.getElementById('pdf-name'),
                    removeBtn: document.getElementById('remove-doc-btn'),
                    status: document.getElementById('doc-status')
                },
                qa: {
                    question: document.getElementById('qa-question'),
                    answer: document.getElementById('qa-answer'),
                    btn: document.getElementById('get-answer-btn'),
                },
                camera: {
                    modal: document.getElementById('camera-modal'),
                    view: document.getElementById('camera-view'),
                    canvas: document.getElementById('capture-canvas'),
                    captureBtn: document.getElementById('capture-btn'),
                    cancelBtn: document.getElementById('cancel-scan-btn'),
                },
                status: {
                    dot: document.getElementById('status-dot'),
                    text: document.getElementById('status-text')
                },
                tone: {
                    select: document.getElementById('tone-select'),
                    btn: document.getElementById('rewrite-tone-btn'),
                }
            };

            // --- State ---
            let state = {
                activeTab: 'text',
                uploadedFile: null,
                cameraStream: null,
            };
            const apiKey = "AIzaSyDKbnMqGRp9z5K0lH7_BNzlYREaLFvW3SU";
            
            // --- Languages ---
            const languages = {'af':'Afrikaans','sq':'Albanian','am':'Amharic','ar':'Arabic','hy':'Armenian','az':'Azerbaijani','eu':'Basque','be':'Belarusian','bn':'Bengali','bs':'Bosnian','bg':'Bulgarian','ca':'Catalan','ceb':'Cebuano','ny':'Chichewa','zh-cn':'Chinese (Simplified)','zh-tw':'Chinese (Traditional)','co':'Corsican','hr':'Croatian','cs':'Czech','da':'Danish','nl':'Dutch','en':'English','eo':'Esperanto','et':'Estonian','tl':'Filipino','fi':'Finnish','fr':'French','fy':'Frisian','gl':'Galician','ka':'Georgian','de':'German','el':'Greek','gu':'Gujarati','ht':'Haitian Creole','ha':'Hausa','haw':'Hawaiian','iw':'Hebrew','hi':'Hindi','hmn':'Hmong','hu':'Hungarian','is':'Icelandic','ig':'Igbo','id':'Indonesian','ga':'Irish','it':'Italian','ja':'Japanese','jw':'Javanese','kn':'Kannada','kk':'Kazakh','km':'Khmer','ko':'Korean','ku':'Kurdish (Kurmanji)','ky':'Kyrgyz','lo':'Lao','la':'Latin','lv':'Latvian','lt':'Lithuanian','lb':'Luxembourgish','mk':'Macedonian','mg':'Malagasy','ms':'Malay','ml':'Malayalam','mt':'Maltese','mi':'Maori','mr':'Marathi','mn':'Mongolian','my':'Myanmar (Burmese)','ne':'Nepali','no':'Norwegian','ps':'Pashto','fa':'Persian','pl':'Polish','pt':'Portuguese','pa':'Punjabi','ro':'Romanian','ru':'Russian','sm':'Samoan','gd':'Scots Gaelic','sr':'Serbian','st':'Sesotho','sn':'Shona','sd':'Sindhi','si':'Sinhala','sk':'Slovak','sl':'Slovenian','so':'Somali','es':'Spanish','su':'Sundanese','sw':'Swahili','sv':'Swedish','tg':'Tajik','ta':'Tamil','te':'Telugu','th':'Thai','tr':'Turkish','uk':'Ukrainian','ur':'Urdu','uz':'Uzbek','vi':'Vietnamese','cy':'Welsh','xh':'Xhosa','yi':'Yiddish','yo':'Yoruba','zu':'Zulu'};
            
            // --- General Functions ---
            const setLoading = (isLoading, element, originalText, loadingText = "...") => {
                const btn = element;
                btn.disabled = isLoading;
                if(isLoading) {
                    btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${loadingText}`;
                } else {
                    btn.innerHTML = originalText;
                }
            };

            const displayError = (msg) => { elements.error.text.textContent = msg; elements.error.el.classList.remove('hidden'); };
            const hideError = () => elements.error.el.classList.add('hidden');
            const showToast = (msg) => {
                elements.toast.textContent = msg;
                elements.toast.classList.remove('opacity-0');
                setTimeout(() => elements.toast.classList.add('opacity-0'), 2000);
            };
            const populateLanguages = () => {
                Object.entries(languages).forEach(([code, name]) => {
                    elements.sourceLang.add(new Option(name, code));
                    elements.targetLang.add(new Option(name, code));
                });
                elements.sourceLang.value = 'en';
                elements.targetLang.value = 'es';
            };

            const updateOnlineStatus = () => {
                const isOnline = navigator.onLine;
                const allButtons = document.querySelectorAll('button');

                if (isOnline) {
                    elements.status.dot.style.backgroundColor = '#22c55e'; // green-500
                    elements.status.text.textContent = 'Online';
                    allButtons.forEach(button => button.disabled = false);
                } else {
                    elements.status.dot.style.backgroundColor = '#ef4444'; // red-500
                    elements.status.text.textContent = 'Offline';
                    allButtons.forEach(button => { if(button.id !== 'cancel-scan-btn') button.disabled = true; });
                    displayError("You are offline. AI features are disabled.");
                }
            };

            // --- Core Actions ---
            const copyToClipboard = () => {
                const textToCopy = elements.targetText.value;
                if (!textToCopy) return;
                navigator.clipboard.writeText(textToCopy).then(() => showToast('Text copied!'), () => displayError('Could not copy text.'));
            };

            const saveTranslation = () => {
                const originalText = elements.sourceText.value;
                const translatedText = elements.targetText.value;
                if (!originalText && !translatedText) { displayError("Nothing to save."); return; }
                const content = `Original Text (${languages[elements.sourceLang.value]}):\n====================\n${originalText}\n\n\nTranslated Text (${languages[elements.targetLang.value]}):\n====================\n${translatedText}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'translation_comparison.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // --- Translation & AI ---
            const performTranslation = async (textToTranslate) => {
                if (!textToTranslate) { elements.targetText.value = ""; return; }
                setLoading(true, elements.translateBtn, elements.btnText.textContent, 'Translating...');
                const sourceLangName = languages[elements.sourceLang.value];
                const targetLangName = languages[elements.targetLang.value];
                const prompt = `Translate the following text from ${sourceLangName} to ${targetLangName}. Respond with only the translated text. Text: "${textToTranslate}"`;
                try {
                    const result = await callGeminiAPI(prompt);
                    elements.targetText.value = result.trim();
                } catch (error) {
                    displayError(`Translation failed: ${error.message}`);
                    elements.targetText.value = "";
                } finally {
                    setLoading(false, elements.translateBtn, elements.btnText.textContent);
                }
            };

            const handleGenerateMessage = async () => {
                const userPrompt = elements.aiPrompt.value.trim();
                if (!userPrompt) { displayError("Please enter a topic for the AI to write about."); return; }
                setLoading(true, elements.generateMsgBtn, 'Generate', 'Generating...');
                const sourceLangName = languages[elements.sourceLang.value];
                const prompt = `You are a helpful assistant. Based on the following request, write a message in ${sourceLangName}. The message should be natural and appropriate for the context. Do not add any extra text, titles, or quotation marks. Just return the message itself.\n\nRequest: "${userPrompt}"`;
                try {
                    const result = await callGeminiAPI(prompt);
                    elements.sourceText.value = result.trim();
                    elements.targetText.value = "";
                } catch (error) {
                    displayError(`Message generation failed: ${error.message}`);
                } finally {
                    setLoading(false, elements.generateMsgBtn, 'Generate');
                }
            };
            
            const handleQuestionAnswer = async () => {
                const question = elements.qa.question.value.trim();
                if (!question) { displayError("Please enter a question."); return; }
                setLoading(true, elements.qa.btn, 'Get Answer', 'Thinking...');
                elements.qa.answer.innerHTML = '<p class="text-gray-500">AI is thinking...</p>';
                const prompt = `You are a helpful Q&A assistant. Provide a clear and well-formatted answer to the following question. Use paragraphs for readability.\n\nQuestion: "${question}"`;
                try {
                    const result = await callGeminiAPI(prompt);
                    elements.qa.answer.innerHTML = result.replace(/\n/g, '<br>');
                } catch(error) {
                    displayError(`Q&A failed: ${error.message}`);
                    elements.qa.answer.innerHTML = '<p class="text-red-500">Sorry, I could not get an answer.</p>';
                } finally {
                    setLoading(false, elements.qa.btn, 'Get Answer');
                }
            };

            const handleRewriteTone = async () => {
                const text = elements.targetText.value;
                if (!text) { displayError("There is no translated text to rewrite."); return; }
                const tone = elements.tone.select.value;
                setLoading(true, elements.tone.btn, 'Rewrite', 'Rewriting...');
                const prompt = `Rewrite the following text in a ${tone} tone. Respond with only the rewritten text.\n\nText: "${text}"`;
                try {
                    const result = await callGeminiAPI(prompt);
                    elements.targetText.value = result.trim();
                } catch(error) {
                    displayError(`Failed to rewrite tone: ${error.message}`);
                } finally {
                    setLoading(false, elements.tone.btn, 'Rewrite');
                }
            };
            
            const handleSummarize = async () => {
                let textToSummarize = elements.sourceText.value.trim();
                if (!textToSummarize) {
                    if (state.uploadedFile) {
                        displayError("Please extract text from the document first before summarizing.");
                    } else {
                        displayError("There is no text to summarize.");
                    }
                    return;
                }
                setLoading(true, elements.doc.summarizeBtn, 'âœ¨ Summarize', 'Summarizing...');
                const prompt = `Provide a concise summary of the following text. Respond with only the summary.\n\nText: "${textToSummarize}"`;
                try {
                    const result = await callGeminiAPI(prompt);
                    elements.sourceText.value = result.trim();
                    elements.targetText.value = "";
                    switchTab('text');
                    showToast("Summary complete!");
                } catch(error) {
                    displayError(`Summarization failed: ${error.message}`);
                } finally {
                    setLoading(false, elements.doc.summarizeBtn, 'âœ¨ Summarize');
                }
            };

            const callGeminiAPI = async (prompt, file = null) => {
                hideError();
                if (!navigator.onLine) {
                   updateOnlineStatus();
                   throw new Error("You are offline.");
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                let parts = [{ text: prompt }];
                if (file) {
                    const base64Data = await toBase64(file);
                    parts.push({ inlineData: { mimeType: file.type, data: base64Data } });
                }
                const payload = { contents: [{ role: "user", parts: parts }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("The API did not return a valid response.");
                return text;
            };
            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            // --- Tab Switching ---
            const switchTab = (tabName) => {
                state.activeTab = tabName;
                elements.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
                Object.values(elements.tabPanes).forEach(pane => pane.classList.add('hidden'));
                elements.tabPanes[tabName].classList.remove('hidden');
                const mainBtnText = (tabName === 'document') ? "Extract & Translate" : "Translate";
                elements.translateBtn.style.display = (tabName === 'website' || tabName === 'qa') ? 'none' : 'inline-block';
                elements.btnText.textContent = mainBtnText;
            };

            // --- Camera Scanner ---
            const startScanner = async () => {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        state.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        elements.camera.view.srcObject = state.cameraStream;
                        elements.camera.modal.classList.remove('hidden');
                    } catch (err) {
                        console.error("Camera Error:", err);
                        displayError("Could not access the camera. Please ensure you have a camera and have granted permission.");
                    }
                } else {
                    displayError("Your browser does not support camera access.");
                }
            };
            
            const stopScanner = () => {
                if (state.cameraStream) {
                    state.cameraStream.getTracks().forEach(track => track.stop());
                }
                elements.camera.modal.classList.add('hidden');
            };

            const captureImage = () => {
                const canvas = elements.camera.canvas;
                const video = elements.camera.view;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                canvas.toBlob(blob => {
                    const file = new File([blob], "scan.jpg", { type: "image/jpeg" });
                    handleDocUpload(file);
                }, 'image/jpeg');
                stopScanner();
            };

            // --- Document Handling ---
            const handleDocUpload = (file) => {
                if (!file) return;
                state.uploadedFile = file;
                elements.doc.dropArea.classList.add('hidden');
                elements.doc.previewContainer.classList.remove('hidden');
                elements.doc.imagePreview.classList.add('hidden');
                elements.doc.pdfPreview.classList.add('hidden');

                if(file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onloadend = () => { elements.doc.imagePreview.src = reader.result; };
                    reader.readAsDataURL(file);
                    elements.doc.imagePreview.classList.remove('hidden');
                } else if (file.type === 'application/pdf') {
                    elements.doc.pdfName.textContent = file.name;
                    elements.doc.pdfPreview.classList.remove('hidden');
                }
                elements.doc.status.textContent = "Document loaded. Ready to extract text.";
                elements.sourceText.value = ""; // Clear old text
                elements.targetText.value = "";
            };

            const removeDoc = () => {
                state.uploadedFile = null;
                elements.doc.uploadInput.value = "";
                elements.doc.previewContainer.classList.add('hidden');
                elements.doc.dropArea.classList.remove('hidden');
                elements.doc.status.textContent = "";
            };

            const extractTextFromDoc = async () => {
                if (!state.uploadedFile) { displayError("Please upload a document first."); return; }
                let extractedText = '';
                const originalBtnText = elements.btnText.textContent;
                setLoading(true, elements.translateBtn, originalBtnText, "Extracting...");
                
                if (state.uploadedFile.type.startsWith('image/')) {
                    elements.doc.status.textContent = "AI is reading the image...";
                    try {
                        const prompt = "Extract all text from this image. Respond with only the extracted text.";
                        extractedText = await callGeminiAPI(prompt, state.uploadedFile);
                    } catch (error) {
                        displayError(`Text extraction failed: ${error.message}`);
                        elements.doc.status.textContent = "Could not read text from image.";
                        setLoading(false, elements.translateBtn, originalBtnText); return;
                    }
                } else if (state.uploadedFile.type === 'application/pdf') {
                    elements.doc.status.textContent = "Reading PDF document...";
                    try {
                         const arrayBuffer = await state.uploadedFile.arrayBuffer();
                         const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                         for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            extractedText += textContent.items.map(item => item.str).join(' ') + '\n';
                         }
                    } catch(error) {
                        displayError(`PDF processing failed: ${error.message}`);
                        setLoading(false, elements.translateBtn, originalBtnText); return;
                    }
                }
                elements.sourceText.value = extractedText.trim();
                elements.doc.status.textContent = "Text extracted successfully! Switching to Text tab for translation.";
                setLoading(false, elements.translateBtn, originalBtnText);
                switchTab('text');
                await performTranslation(extractedText.trim());
            };

            // --- Event Listeners ---
            elements.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            elements.generateMsgBtn.addEventListener('click', handleGenerateMessage);
            elements.qa.btn.addEventListener('click', handleQuestionAnswer);
            elements.tone.btn.addEventListener('click', handleRewriteTone);
            elements.doc.summarizeBtn.addEventListener('click', handleSummarize);
            elements.translateBtn.addEventListener('click', () => {
                if (state.activeTab === 'text') performTranslation(elements.sourceText.value);
                else if (state.activeTab === 'document') extractTextFromDoc();
            });
            elements.swapBtn.addEventListener('click', () => { [elements.sourceLang.value, elements.targetLang.value] = [elements.targetLang.value, elements.sourceLang.value]; });
            elements.clearBtn.addEventListener('click', () => { elements.sourceText.value = ''; elements.targetText.value = ''; hideError(); });
            elements.copyBtn.addEventListener('click', copyToClipboard);
            elements.saveBtn.addEventListener('click', saveTranslation);
            
            // Network Status Listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            // Document Listeners
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => elements.doc.dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(eventName => elements.doc.dropArea.addEventListener(eventName, () => elements.doc.dropArea.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(eventName => elements.doc.dropArea.addEventListener(eventName, () => elements.doc.dropArea.classList.remove('dragover')));
            elements.doc.dropArea.addEventListener('drop', e => handleDocUpload(e.dataTransfer.files[0]));
            elements.doc.uploadInput.addEventListener('change', e => handleDocUpload(e.target.files[0]));
            elements.doc.removeBtn.addEventListener('click', removeDoc);
            elements.doc.scanBtn.addEventListener('click', startScanner);

            // Camera Listeners
            elements.camera.captureBtn.addEventListener('click', captureImage);
            elements.camera.cancelBtn.addEventListener('click', stopScanner);

            // --- Initialization ---
            populateLanguages();
            updateOnlineStatus();
            switchTab('text');
        });
    </script>
</body>
</html>
