<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panorama Online Form Service - Advanced Billing</title>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 5px 5px 0 0;
            margin-bottom: 20px;
        }
        
        .company-info {
            margin-bottom: 10px;
        }
        
        .company-info h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .company-info p {
            font-size: 14px;
        }
        
        .login-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .login-section.active {
            display: block;
        }
        
        .billing-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .billing-section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f9f9f9;
        }
        
        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .payment-method {
            flex: 1;
            min-width: 200px;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .payment-method:hover {
            background-color: #dfe6e9;
        }
        
        .payment-method.active {
            border-color: var(--secondary-color);
            background-color: #d6eaf8;
        }
        
        .payment-method img {
            max-width: 100px;
            max-height: 40px;
            display: block;
            margin-bottom: 10px;
        }
        
        .qr-section {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 180px;
            height: 180px;
            margin: 0 auto 15px;
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .bill-summary {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .bill-summary h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 18px;
            border-bottom: none;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #777;
            font-size: 14px;
        }
        
        .payment-status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .payment-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .payment-failed {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .payment-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Nepali font support */
        .nepali-font {
            font-family: 'Preeti', 'Mangal', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="company-info">
                <h1>Panorama Online Form Service Pvt. Ltd.</h1>
                <p>Tel: +977 9702397558 Email: form@nbp.com.np</p>
            </div>
        </header>
        
        <!-- Login Section -->
        <section class="login-section active" id="loginSection">
            <h2>Login to Billing System</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </section>
        
        <!-- Billing Section -->
        <section class="billing-section" id="billingSection">
            <div class="no-print">
                <h2>Create New Bill</h2>
                <div class="form-group">
                    <label for="customerName">Customer Name</label>
                    <input type="text" id="customerName" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label for="customerAddress">Customer Address</label>
                    <input type="text" id="customerAddress" placeholder="Enter customer address">
                </div>
                <div class="form-group">
                    <label for="customerPhone">Customer Phone</label>
                    <input type="tel" id="customerPhone" placeholder="Enter customer phone number">
                </div>
                
                <h3>Add Items</h3>
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" placeholder="Enter item name">
                </div>
                <div class="row">
                    <div class="form-group" style="width: 30%; display: inline-block;">
                        <label for="itemQuantity">Quantity</label>
                        <input type="number" id="itemQuantity" placeholder="Qty" value="1" min="1">
                    </div>
                    <div class="form-group" style="width: 30%; display: inline-block;">
                        <label for="itemRate">Rate (Rs.)</label>
                        <input type="number" id="itemRate" placeholder="Rate" min="0" step="0.01">
                    </div>
                    <div class="form-group" style="width: 30%; display: inline-block;">
                        <label for="itemDiscount">Discount (%)</label>
                        <input type="number" id="itemDiscount" placeholder="Discount" min="0" max="100" value="0">
                    </div>
                </div>
                <button id="addItemBtn" class="btn">Add Item</button>
                
                <h3>Items List</h3>
                <div class="table-responsive">
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>SN</th>
                                <th>Item Name</th>
                                <th>Qty</th>
                                <th>Rate</th>
                                <th>Discount</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Payment Method</h3>
                <div class="payment-methods">
                    <div class="payment-method" data-method="esewa">
                        <img src="https://khalti.com/static/img/esewa.png" alt="eSewa">
                        <p>eSewa</p>
                    </div>
                    <div class="payment-method" data-method="khalti">
                        <img src="https://khalti.com/static/img/khalti.png" alt="Khalti">
                        <p>Khalti</p>
                    </div>
                    <div class="payment-method" data-method="bank">
                        <img src="https://cdn-icons-png.flaticon.com/512/2489/2489759.png" alt="Bank Transfer" style="width: 40px;">
                        <p>Bank Transfer</p>
                    </div>
                    <div class="payment-method active" data-method="cash">
                        <img src="https://cdn-icons-png.flaticon.com/512/2703/2703983.png" alt="Cash" style="width: 40px;">
                        <p>Cash</p>
                    </div>
                </div>
                
                <div class="form-group" id="bankDetails" style="display: none;">
                    <label for="bankName">Bank Name</label>
                    <input type="text" id="bankName" placeholder="Enter bank name">
                    <label for="transactionId">Transaction ID</label>
                    <input type="text" id="transactionId" placeholder="Enter transaction ID">
                </div>
                
                <div class="qr-section" id="qrSection" style="display: none;">
                    <h3>Scan to Pay</h3>
                    <div id="qrCode" class="qr-code"></div>
                    <p>Scan this QR code to make payment</p>
                    <div id="paymentStatus" class="payment-status"></div>
                    <button id="checkPaymentBtn" class="btn" style="display: none; margin-top: 10px;">Check Payment Status</button>
                </div>
            </div>
            
            <!-- Bill Summary and Print Section -->
            <div class="bill-summary print-section" id="billSummary">
                <h3>Bill Summary</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount">Rs. 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Discount:</span>
                    <span id="totalDiscount">Rs. 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax (0%):</span>
                    <span id="taxAmount">Rs. 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total Amount:</span>
                    <span id="totalAmount">Rs. 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Payment Method:</span>
                    <span id="paymentMethodDisplay">Cash</span>
                </div>
                <div class="summary-row">
                    <span>Payment Status:</span>
                    <span id="paymentStatusDisplay">Not Paid</span>
                </div>
                <div id="printQrCode" style="text-align: center; margin-top: 15px;"></div>
            </div>
            
            <div class="action-buttons no-print">
                <button id="clearBillBtn" class="btn btn-danger">Clear Bill</button>
                <button id="generatePaymentBtn" class="btn" style="display: none;">Generate Payment QR</button>
                <button id="printBillBtn" class="btn">Print Bill</button>
                <button id="saveBillBtn" class="btn btn-success">Save Bill</button>
            </div>
        </section>
        
        <footer>
            <p>&copy; <span id="currentYear"></span> Panorama Online Form Service Pvt. Ltd. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // DOM Elements
            const loginSection = document.getElementById('loginSection');
            const billingSection = document.getElementById('billingSection');
            const loginForm = document.getElementById('loginForm');
            const itemsTable = document.getElementById('itemsTable');
            const itemsList = document.getElementById('itemsList');
            const addItemBtn = document.getElementById('addItemBtn');
            const clearBillBtn = document.getElementById('clearBillBtn');
            const printBillBtn = document.getElementById('printBillBtn');
            const saveBillBtn = document.getElementById('saveBillBtn');
            const generatePaymentBtn = document.getElementById('generatePaymentBtn');
            const checkPaymentBtn = document.getElementById('checkPaymentBtn');
            const paymentMethods = document.querySelectorAll('.payment-method');
            const bankDetails = document.getElementById('bankDetails');
            const qrSection = document.getElementById('qrSection');
            const qrCodeDiv = document.getElementById('qrCode');
            const paymentStatus = document.getElementById('paymentStatus');
            const paymentMethodDisplay = document.getElementById('paymentMethodDisplay');
            const paymentStatusDisplay = document.getElementById('paymentStatusDisplay');
            const printQrCode = document.getElementById('printQrCode');
            
            // Bill data
            let items = [];
            let currentPaymentMethod = 'cash';
            let paymentGenerated = false;
            let paymentConfirmed = false;
            let qrCode = null;
            let billNumber = generateBillNumber();
            
            // Generate random bill number
            function generateBillNumber() {
                const date = new Date();
                const year = date.getFullYear().toString().slice(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                return `INV-${year}${month}${day}-${randomNum}`;
            }
            
            // Login functionality
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Simple validation (in real app, this would be server-side)
                if (username === 'admin' && password === 'admin123') {
                    loginSection.classList.remove('active');
                    billingSection.classList.add('active');
                } else {
                    alert('Invalid username or password');
                }
            });
            
            // Add item to bill
            addItemBtn.addEventListener('click', function() {
                const itemName = document.getElementById('itemName').value;
                const quantity = parseInt(document.getElementById('itemQuantity').value);
                const rate = parseFloat(document.getElementById('itemRate').value);
                const discount = parseFloat(document.getElementById('itemDiscount').value);
                
                if (!itemName || isNaN(quantity) || isNaN(rate)) {
                    alert('Please fill all required fields with valid values');
                    return;
                }
                
                const amount = quantity * rate;
                const discountAmount = amount * (discount / 100);
                const finalAmount = amount - discountAmount;
                
                const item = {
                    name: itemName,
                    quantity: quantity,
                    rate: rate,
                    discount: discount,
                    amount: finalAmount
                };
                
                items.push(item);
                updateItemsTable();
                calculateTotals();
                
                // Clear input fields
                document.getElementById('itemName').value = '';
                document.getElementById('itemQuantity').value = '1';
                document.getElementById('itemRate').value = '';
                document.getElementById('itemDiscount').value = '0';
                document.getElementById('itemName').focus();
            });
            
            // Update items table
            function updateItemsTable() {
                itemsList.innerHTML = '';
                
                items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>Rs. ${item.rate.toFixed(2)}</td>
                        <td>${item.discount}%</td>
                        <td>Rs. ${item.amount.toFixed(2)}</td>
                        <td><button class="btn btn-danger" data-index="${index}" style="padding: 5px 10px; font-size: 12px;">Remove</button></td>
                    `;
                    itemsList.appendChild(row);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('#itemsList .btn-danger').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        items.splice(index, 1);
                        updateItemsTable();
                        calculateTotals();
                    });
                });
            }
            
            // Calculate totals
            function calculateTotals() {
                if (items.length === 0) {
                    // Reset all values if no items
                    document.getElementById('subtotalAmount').textContent = 'Rs. 0.00';
                    document.getElementById('totalDiscount').textContent = 'Rs. 0.00';
                    document.getElementById('taxAmount').textContent = 'Rs. 0.00';
                    document.getElementById('totalAmount').textContent = 'Rs. 0.00';
                    generatePaymentBtn.style.display = 'none';
                    qrSection.style.display = 'none';
                    return;
                }
                
                const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
                const totalDiscount = items.reduce((sum, item) => sum + (item.quantity * item.rate * item.discount / 100), 0);
                const taxableAmount = subtotal - totalDiscount;
                const tax = taxableAmount * 0.0;
                const total = taxableAmount + tax;
                
                document.getElementById('subtotalAmount').textContent = `Rs. ${subtotal.toFixed(2)}`;
                document.getElementById('totalDiscount').textContent = `Rs. ${totalDiscount.toFixed(2)}`;
                document.getElementById('taxAmount').textContent = `Rs. ${tax.toFixed(2)}`;
                document.getElementById('totalAmount').textContent = `Rs. ${total.toFixed(2)}`;
                
                // Show generate payment button for digital payments
                if (currentPaymentMethod !== 'cash' && total > 0) {
                    generatePaymentBtn.style.display = 'inline-block';
                } else {
                    generatePaymentBtn.style.display = 'none';
                }
            }
            
            // Payment method selection
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    paymentMethods.forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    currentPaymentMethod = this.getAttribute('data-method');
                    paymentMethodDisplay.textContent = this.querySelector('p').textContent;
                    paymentStatusDisplay.textContent = 'Not Paid';
                    
                    if (currentPaymentMethod === 'bank') {
                        bankDetails.style.display = 'block';
                        qrSection.style.display = 'none';
                    } else {
                        bankDetails.style.display = 'none';
                    }
                    
                    // Show/hide generate payment button
                    const total = parseFloat(document.getElementById('totalAmount').textContent.replace('Rs. ', ''));
                    if (currentPaymentMethod !== 'cash' && total > 0) {
                        generatePaymentBtn.style.display = 'inline-block';
                    } else {
                        generatePaymentBtn.style.display = 'none';
                        qrSection.style.display = 'none';
                    }
                    
                    // Reset payment status
                    paymentGenerated = false;
                    paymentConfirmed = false;
                    paymentStatus.style.display = 'none';
                    checkPaymentBtn.style.display = 'none';
                });
            });
            
            // Generate payment QR code
            generatePaymentBtn.addEventListener('click', function() {
                const totalAmount = parseFloat(document.getElementById('totalAmount').textContent.replace('Rs. ', ''));
                
                if (totalAmount <= 0) {
                    alert('Total amount must be greater than 0');
                    return;
                }
                
                // Clear previous QR code
                qrCodeDiv.innerHTML = '';
                
                // Generate payment URL based on method
                let paymentUrl = '';
                let paymentDetails = '';
                
                switch(currentPaymentMethod) {
                    case 'esewa':
                        paymentUrl = `esewa://payment?amt=${totalAmount}&pid=${billNumber}&scd=Panorama&su=Payment for Bill ${billNumber}`;
                        paymentDetails = `eSewa Payment: Rs. ${totalAmount.toFixed(2)}`;
                        break;
                    case 'khalti':
                        paymentUrl = `khalti://payment?amount=${totalAmount * 100}&billNumber=${billNumber}&merchant=Panorama Online Form Service`;
                        paymentDetails = `Khalti Payment: Rs. ${totalAmount.toFixed(2)}`;
                        break;
                    default:
                        paymentUrl = `https://panorama-online.com/pay?amount=${totalAmount}&bill=${billNumber}`;
                        paymentDetails = `Payment Link: Rs. ${totalAmount.toFixed(2)}`;
                }
                
                // Generate QR code
                qrCode = new QRCode(qrCodeDiv, {
                    text: paymentUrl,
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Show QR section
                qrSection.style.display = 'block';
                paymentGenerated = true;
                paymentConfirmed = false;
                
                // Simulate payment verification (in real app, this would connect to payment gateway API)
                setTimeout(() => {
                    // 70% chance of successful payment for demo
                    const isSuccess = Math.random() < 0.7;
                    simulatePaymentVerification(isSuccess);
                }, 3000);
            });
            
            // Simulate payment verification
            function simulatePaymentVerification(isSuccess) {
                if (!paymentGenerated || paymentConfirmed) return;
                
                const statusDiv = paymentStatus;
                statusDiv.style.display = 'block';
                checkPaymentBtn.style.display = 'inline-block';
                
                if (isSuccess) {
                    statusDiv.className = 'payment-status payment-success';
                    statusDiv.innerHTML = '<strong>Payment Successful!</strong> Your payment has been verified.';
                    paymentStatusDisplay.textContent = 'Paid';
                    paymentConfirmed = true;
                    checkPaymentBtn.style.display = 'none';
                    
                    // Update print QR code
                    printQrCode.innerHTML = '';
                    const printQr = new QRCode(printQrCode, {
                        text: `Payment Verified - ${billNumber}`,
                        width: 100,
                        height: 100,
                        colorDark: "#27ae60",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    statusDiv.className = 'payment-status payment-pending';
                    statusDiv.innerHTML = '<strong>Payment Pending:</strong> Waiting for payment confirmation.';
                    paymentStatusDisplay.textContent = 'Pending';
                }
            }
            
            // Check payment status button
            checkPaymentBtn.addEventListener('click', function() {
                if (!paymentGenerated) return;
                
                // Simulate checking payment status (in real app, this would call payment gateway API)
                const isSuccess = Math.random() < 0.8; // 80% chance of success on retry
                simulatePaymentVerification(isSuccess);
            });
            
            // Clear bill
            clearBillBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the current bill?')) {
                    items = [];
                    updateItemsTable();
                    calculateTotals();
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerAddress').value = '';
                    document.getElementById('customerPhone').value = '';
                    
                    // Reset payment method to cash
                    paymentMethods.forEach(m => m.classList.remove('active'));
                    document.querySelector('.payment-method[data-method="cash"]').classList.add('active');
                    currentPaymentMethod = 'cash';
                    paymentMethodDisplay.textContent = 'Cash';
                    paymentStatusDisplay.textContent = 'Not Paid';
                    bankDetails.style.display = 'none';
                    qrSection.style.display = 'none';
                    generatePaymentBtn.style.display = 'none';
                    paymentStatus.style.display = 'none';
                    checkPaymentBtn.style.display = 'none';
                    printQrCode.innerHTML = '';
                    
                    // Generate new bill number
                    billNumber = generateBillNumber();
                    paymentGenerated = false;
                    paymentConfirmed = false;
                }
            });
            
            // Print bill
            printBillBtn.addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Please add items to the bill before printing');
                    return;
                }
                
                // Create a printable bill
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Bill Invoice - ${billNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                            .invoice { max-width: 800px; margin: 0 auto; }
                            .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                            .header h1 { margin: 0; font-size: 24px; }
                            .header p { margin: 5px 0; }
                            .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                            .bill-info { text-align: right; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .total { text-align: right; font-weight: bold; }
                            .footer { margin-top: 30px; text-align: center; font-size: 12px; border-top: 1px solid #ddd; padding-top: 10px; }
                            .qr-code { text-align: center; margin: 15px 0; }
                            .payment-status { padding: 5px; border-radius: 3px; text-align: center; margin: 10px 0; }
                            .paid { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
                            .pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
                        </style>
                    </head>
                    <body>
                        <div class="invoice">
                            <div class="header">
                                <h1>Panorama Online Form Service Pvt. Ltd.</h1>
                                <p>Tel: +977 9702397558</p>
                                <h2>TAX INVOICE</h2>
                                <p><strong>Bill No:</strong> ${billNumber}</p>
                            </div>
                            
                            <div class="info">
                                <div>
                                    <p><strong>Bill To:</strong> ${document.getElementById('customerName').value || 'Walk-in Customer'}</p>
                                    <p>${document.getElementById('customerAddress').value || ''}</p>
                                    <p>${document.getElementById('customerPhone').value || ''}</p>
                                </div>
                                <div class="bill-info">
                                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>Payment Method:</strong> ${paymentMethodDisplay.textContent}</p>
                                    <p><strong>Payment Status:</strong> ${paymentStatusDisplay.textContent}</p>
                                </div>
                            </div>
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th>SN</th>
                                        <th>Item Description</th>
                                        <th>Qty</th>
                                        <th>Rate</th>
                                        <th>Discount</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map((item, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>Rs. ${item.rate.toFixed(2)}</td>
                                            <td>${item.discount}%</td>
                                            <td>Rs. ${item.amount.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div>
                                <p class="total">Subtotal: ${document.getElementById('subtotalAmount').textContent}</p>
                                <p class="total">Discount: ${document.getElementById('totalDiscount').textContent}</p>
                                <p class="total">Tax (13%): ${document.getElementById('taxAmount').textContent}</p>
                                <p class="total">Total Amount: ${document.getElementById('totalAmount').textContent}</p>
                            </div>
                            
                            ${paymentConfirmed ? `
                                <div class="payment-status paid">
                                    <strong>PAYMENT RECEIVED</strong>
                                </div>
                            ` : paymentStatusDisplay.textContent === 'Pending' ? `
                                <div class="payment-status pending">
                                    <strong>PAYMENT PENDING</strong>
                                </div>
                            ` : ''}
                            
                            <div class="qr-code" id="printQrCodeContainer"></div>
                            
                            <div class="footer">
                                <p>Thank you for your business!</p>
                                <p>Panorama Online Form Service Pvt. Ltd.</p>
                                <p>This is a computer generated invoice</p>
                            </div>
                        </div>
                        <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"><\/script>
                        <script>
                            window.onload = function() {
                                ${paymentConfirmed ? `
                                    new QRCode(document.getElementById('printQrCodeContainer'), {
                                        text: 'Payment Verified - ${billNumber}',
                                        width: 100,
                                        height: 100,
                                        colorDark: "#27ae60",
                                        colorLight: "#ffffff",
                                        correctLevel: QRCode.CorrectLevel.H
                                    });
                                ` : ''}
                                
                                setTimeout(function() {
                                    window.print();
                                    window.close();
                                }, 500);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            });
            
            // Save bill (in a real app, this would save to a database)
            saveBillBtn.addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Please add items to the bill before saving');
                    return;
                }
                
                // Check if payment is required for digital methods
                if (currentPaymentMethod !== 'cash' && !paymentConfirmed) {
                    if (confirm('Payment not verified for this bill. Save anyway?')) {
                        // Continue with saving
                    } else {
                        return;
                    }
                }
                
                // In a real app, you would send this data to your server
                const billData = {
                    billNumber: billNumber,
                    customer: {
                        name: document.getElementById('customerName').value || 'Walk-in Customer',
                        address: document.getElementById('customerAddress').value || '',
                        phone: document.getElementById('customerPhone').value || ''
                    },
                    items: items,
                    paymentMethod: currentPaymentMethod,
                    paymentStatus: paymentConfirmed ? 'paid' : (paymentGenerated ? 'pending' : 'not_paid'),
                    subtotal: document.getElementById('subtotalAmount').textContent,
                    discount: document.getElementById('totalDiscount').textContent,
                    tax: document.getElementById('taxAmount').textContent,
                    total: document.getElementById('totalAmount').textContent,
                    date: new Date().toISOString()
                };
                
                // For demo purposes, we'll just show the data
                console.log('Bill data:', billData);
                alert(`Bill ${billNumber} saved successfully!\nTotal: ${billData.total}\nPayment Status: ${billData.paymentStatus}`);
                
                // Clear the form after saving
                items = [];
                updateItemsTable();
                calculateTotals();
                document.getElementById('customerName').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('customerPhone').value = '';
                
                // Generate new bill number for next bill
                billNumber = generateBillNumber();
                paymentGenerated = false;
                paymentConfirmed = false;
                qrSection.style.display = 'none';
                paymentStatus.style.display = 'none';
                checkPaymentBtn.style.display = 'none';
                printQrCode.innerHTML = '';
            });
        });
    </script>
</body>
</html>
